name: Release Extension

on:
  push:
    tags:
      - "v*" # å½“æ¨é€ä»¥ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼Œä¾‹å¦‚ v1.0.0
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: "Version tag (e.g., v1.0.0)"
        required: true

jobs:
  build-and-package:
    name: Build and Package Extension
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: npm run build

      - name: Package extension
        run: npm run package

      - name: Get version from package.json
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Find package file
        id: find-package
        run: |
          PACKAGE_FILE=$(find . -name "*.zip" -type f | head -n 1)
          if [ -z "$PACKAGE_FILE" ]; then
            echo "Package file not found!"
            exit 1
          fi
          echo "file=$PACKAGE_FILE" >> $GITHUB_OUTPUT
          echo "filename=$(basename $PACKAGE_FILE)" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body: |
            ## ğŸ‰ Everything Chrome Extension ${{ steps.tag.outputs.tag }}

            ### ğŸ“¦ æ„å»ºä¿¡æ¯
            - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp || github.run_started_at }}
            - **æäº¤**: ${{ github.sha }}
            - **å·¥ä½œæµ**: ${{ github.workflow }}

            ### ğŸ“¥ å®‰è£…è¯´æ˜
            1. ä¸‹è½½é™„ä»¶ä¸­çš„ `.zip` æ–‡ä»¶
            2. è§£å‹åˆ°æœ¬åœ°ç›®å½•
            3. æ‰“å¼€ Chrome æµè§ˆå™¨ï¼Œè®¿é—® `chrome://extensions`
            4. å¯ç”¨"å¼€å‘è€…æ¨¡å¼"
            5. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"
            6. é€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹

            ### ğŸ“ æ›´æ–°æ—¥å¿—
            æŸ¥çœ‹ [CHANGELOG.md](../CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
          files: ${{ steps.find-package.outputs.file }}
          draft: false
          prerelease: ${{ contains(steps.tag.outputs.tag, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extension-package-${{ steps.tag.outputs.tag }}
          path: ${{ steps.find-package.outputs.file }}
          retention-days: 30
